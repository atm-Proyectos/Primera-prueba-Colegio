<div class="dashboard-panel">
  <h2>ğŸ‘¨â€ğŸ“ GestiÃ³n de Alumnos</h2>

  <div *ngIf="mensajeError" class="alerta-error">
    {{ mensajeError }}
  </div>

  <form #formAlu="ngForm" (ngSubmit)="guardar()">
    <div class="filtros-dashboard" style="display: flex; gap: 10px; align-items: flex-start;">

      <div style="flex: 1;">
        <input type="text" [(ngModel)]="formAlumno.nombre" name="nombre" required minlength="2" maxlength="50"
          pattern="^[a-zA-ZÃ±Ã‘Ã¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“Ãš\s\.-]+$" placeholder="Nombre" #nombre="ngModel"
          [class.input-error]="nombre.invalid && (nombre.dirty || nombre.touched)" style="width: 100%;">

        <small *ngIf="nombre.invalid && (nombre.dirty || nombre.touched)" class="msg-error">
          <div *ngIf="nombre.errors?.['required']">Obligatorio.</div>
          <div *ngIf="nombre.errors?.['minlength']">MÃ­nimo 2 letras.</div>
          <div *ngIf="nombre.errors?.['pattern']">Solo letras.</div>
        </small>
      </div>

      <div style="flex: 1;">
        <input type="text" [(ngModel)]="formAlumno.apellido" name="apellido" required minlength="2" maxlength="100"
          pattern="^[a-zA-ZÃ±Ã‘Ã¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“Ãš\s\.-]+$" placeholder="Apellidos" #apellido="ngModel"
          [class.input-error]="apellido.invalid && (apellido.dirty || apellido.touched)" style="width: 100%;">

        <small *ngIf="apellido.invalid && (apellido.dirty || apellido.touched)" class="msg-error">
          <div *ngIf="apellido.errors?.['required']">Obligatorio.</div>
          <div *ngIf="apellido.errors?.['minlength']">MÃ­nimo 2 letras.</div>
          <div *ngIf="apellido.errors?.['pattern']">Solo letras.</div>
        </small>
      </div>

      <div style="width: 100px;">
        <input type="number" [(ngModel)]="formAlumno.edad" name="edad" required min="3" max="99" placeholder="Edad"
          #edad="ngModel" [class.input-error]="edad.invalid && (edad.dirty || edad.touched)" style="width: 100%;">

        <small *ngIf="edad.invalid && (edad.dirty || edad.touched)" class="msg-error">
          <div *ngIf="edad.errors?.['required']">Obligatorio.</div>
          <div *ngIf="edad.errors?.['min']">Min 3.</div>
          <div *ngIf="edad.errors?.['max']">Max 99.</div>
        </small>
      </div>

      <div style="display: flex; gap: 5px;">
        <button type="submit" class="btn-guardar" [disabled]="formAlu.invalid || (cargando$ | async)"
          [title]="formAlu.invalid ? 'Rellena todos los campos' : 'Guardar'">
          {{ formAlumno.id === 0 ? 'ğŸ’¾ Crear' : 'ğŸ”„ Actualizar' }}
        </button>

        <button *ngIf="formAlumno.id !== 0" type="button" (click)="limpiar()" class="btn-cancelar">
          âŒ
        </button>
      </div>

    </div>
  </form>

  <div *ngIf="(cargando$ | async)" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando alumnos...</p>
  </div>

  <table class="tabla-datos" *ngIf="!(cargando$ | async)">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Apellido</th>
        <th>Edad</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let alumno of alumnos$ | async">
        <td>{{ alumno.nombre }}</td>
        <td>{{ alumno.apellido }}</td>
        <td>{{ alumno.edad }} aÃ±os</td>
        <td>
          <button (click)="editar(alumno)" class="btn-editar" title="Editar datos">âœï¸</button>
          <button (click)="eliminar(alumno.id)" class="btn-borrar" title="Borrar alumno">ğŸ—‘ï¸</button>
          <button (click)="abrirMatriculas(alumno)" class="btn-matricular" title="Gestionar asignaturas">ğŸ“</button>
        </td>
      </tr>
      <tr *ngIf="(alumnos$ | async)?.length === 0">
        <td colspan="4" style="text-align:center; padding: 20px; color: #777;">
          No hay alumnos registrados.
        </td>
      </tr>
    </tbody>
  </table>

  <div class="modal-overlay" *ngIf="modoMatricula">
    <div class="modal-content">
      <h3>ğŸ“ MatrÃ­culas de: {{ alumnoSeleccionado.nombre }}</h3>
      <div class="form-matricula">
        <select [(ngModel)]="asignaturaParaMatricular" style="flex:1; margin-right:5px;">
          <option [ngValue]="null">-- Elegir Asignatura --</option>
          <option *ngFor="let asig of listaAsignaturas" [ngValue]="asig.id">
            {{ asig.clase }}
          </option>
        </select>
        <button (click)="matricular()" class="btn-guardar" [disabled]="!asignaturaParaMatricular">
          â• AÃ±adir
        </button>
      </div>
      <hr>
      <ul class="lista-asignaturas">
        <li *ngFor="let m of matriculasAlumno">
          {{ m.asignatura }}
          <button (click)="eliminarMatricula(m.id)" style="background:none; border:none; cursor:pointer;"
            title="Desmatricular">
            âŒ
          </button>
        </li>
        <li *ngIf="matriculasAlumno.length === 0" style="text-align:center; color:#999;">
          Sin asignaturas asignadas.
        </li>
      </ul>
      <button (click)="cerrarMatriculas()" class="btn-cerrar-modal">Cerrar</button>
    </div>
  </div>
</div>
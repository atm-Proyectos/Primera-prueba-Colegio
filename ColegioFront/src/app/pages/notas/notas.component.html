<div class="dashboard-panel">
  <h2>ğŸ“ GestiÃ³n de Notas</h2>

  <div *ngIf="mensajeError" class="alerta-error">
    {{ mensajeError }}
  </div>

  <form #formNotas="ngForm" (ngSubmit)="guardar()">
    <div class="filtros-dashboard" style="align-items: flex-start;">

      <div style="flex: 1;">
        <select [(ngModel)]="formSeleccion.alumnoId" name="alumnoId" required style="width: 100%;"
          (change)="alCambiarAlumno()" #alumnoRef="ngModel"
          [class.input-error]="alumnoRef.invalid && (alumnoRef.dirty || alumnoRef.touched)">

          <option [ngValue]="null">-- Selecciona Alumno --</option>
          <option *ngFor="let alu of listaAlumnos" [ngValue]="alu.id">
            {{ alu.nombre }} {{ alu.apellido }}
          </option>
        </select>

        <small *ngIf="alumnoRef.invalid && (alumnoRef.dirty || alumnoRef.touched)" class="msg-error">
          <div *ngIf="alumnoRef.errors?.['required']">Debes elegir un alumno.</div>
        </small>
      </div>

      <div style="flex: 1;">
        <select [(ngModel)]="formSeleccion.asignaturaId" name="asignaturaId" required style="width: 100%;"
          [disabled]="!formSeleccion.alumnoId" #asigRef="ngModel"
          [class.input-error]="asigRef.invalid && (asigRef.dirty || asigRef.touched)">

          <option [ngValue]="null">-- Selecciona Asignatura --</option>
          <option *ngFor="let asig of listaAsignaturasDelAlumno" [ngValue]="asig.idAsignaturaReal">
            {{ asig.nombreAsignatura }}
          </option>
        </select>

        <small *ngIf="asigRef.invalid && (asigRef.dirty || asigRef.touched)" class="msg-error">
          <div *ngIf="asigRef.errors?.['required']">Debes elegir una asignatura.</div>
        </small>
      </div>

      <div style="width: 140px; position: relative; margin-right: 10px;">

        <input type="number" [(ngModel)]="valorNota" name="valorNota" placeholder="0 - 10" required min="0" max="10"
          step="0.01" (keydown)="evitarSimbolos($event)" #notaRef="ngModel"
          [class.input-error]="notaRef.invalid && (notaRef.dirty || notaRef.touched)" style="width: 100%;">

        <div style="position: absolute; top: 100%; left: 0; width: 140px; z-index: 10;">

          <small *ngIf="mostrarAvisoSimbolos"
            style="color: #d35400; background: #fae5d3; padding: 2px 5px; display: block; border: 1px solid #d35400; border-radius: 4px;">
            âš ï¸ Solo nÃºmeros (0-10)
          </small>

          <small *ngIf="notaRef.invalid && (notaRef.dirty || notaRef.touched) && !mostrarAvisoSimbolos"
            class="msg-error" style="background: white; display: block;">

            <div *ngIf="notaRef.errors?.['required']">âš ï¸ Obligatorio.</div>
            <div *ngIf="notaRef.errors?.['min']">â›” MÃ­nimo 0.</div>
            <div *ngIf="notaRef.errors?.['max']">â›” MÃ¡ximo 10.</div>
          </small>

        </div>
      </div>

      <div>
        <button type="submit" class="btn-guardar" [disabled]="formNotas.invalid || (cargando$ | async)"
          [title]="formNotas.invalid ? 'Rellena todos los campos correctamente' : 'Guardar'">
          {{ notaIdEditar === 0 ? 'ğŸ’¾ Guardar' : 'ğŸ”„ Actualizar' }}
        </button>

        <button *ngIf="notaIdEditar !== 0" type="button" (click)="limpiar()" class="btn-cancelar">âŒ</button>
      </div>
    </div>
  </form>
</div>

<div *ngIf="(cargando$ | async)" class="loading-container">
  <app-spinner></app-spinner>
  <p>Procesando notas...</p>
</div>

<table class="tabla-datos" *ngIf="!(cargando$ | async)">
  <thead>
    <tr>
      <th>Alumno</th>
      <th>Asignatura</th>
      <th>Nota</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let nota of notas$ | async">
      <td>{{ nota.nombreAlumno }}</td>
      <td>{{ nota.nombreAsignatura }}</td>
      <td [style.color]="nota.valor >= 5 ? 'green' : 'red'" style="font-weight: bold;">
        {{ nota.valor }}
      </td>
      <td>
        <button (click)="editar(nota)" class="btn-editar">âœï¸</button>
        <button (click)="eliminar(nota.id)" class="btn-borrar">ğŸ—‘ï¸</button>
      </td>
    </tr>
  </tbody>
</table>
<div class="dashboard-panel">
  <h2>ğŸ“ GestiÃ³n de Notas</h2>

  <div *ngIf="!api.soyAlumno()">

    <div *ngIf="mensajeError" class="alerta-error">
      {{ mensajeError }}
    </div>

    <form #formNotas="ngForm" (ngSubmit)="guardar()">
      <div class="filtros-dashboard" style="align-items: flex-start;">

        <div style="flex: 1;">
          <label class="form-label">Alumno:</label>
          <select class="form-control" [(ngModel)]="formSeleccion.alumnoId" name="alumnoId" required
            style="width: 100%;" (change)="alCambiarAlumno()" #alumnoRef="ngModel"
            [class.input-error]="alumnoRef.invalid && (alumnoRef.dirty || alumnoRef.touched)">

            <option [ngValue]="null">-- Selecciona Alumno --</option>
            <option *ngFor="let alu of listaAlumnos" [ngValue]="alu.id">
              {{ alu.nombre }} {{ alu.apellido }}
            </option>
          </select>

          <small *ngIf="alumnoRef.invalid && (alumnoRef.dirty || alumnoRef.touched)" class="msg-error">
            <div *ngIf="alumnoRef.errors?.['required']">Debes elegir un alumno.</div>
          </small>
        </div>

        <div style="flex: 1;">
          <label class="form-label">Asignatura:</label>
          <select class="form-control" [(ngModel)]="formSeleccion.asignaturaId" name="asignaturaId" required
            style="width: 100%;" [disabled]="listaAsignaturasDelAlumno.length === 0" #asigRef="ngModel"
            [class.input-error]="asigRef.invalid && (asigRef.dirty || asigRef.touched)">

            <option [ngValue]="null">-- Selecciona Asignatura --</option>
            <option *ngFor="let asig of listaAsignaturasDelAlumno" [ngValue]="asig.id">
              {{ asig.nombre }}
            </option>
          </select>

          <small *ngIf="formSeleccion.alumnoId && listaAsignaturasDelAlumno.length === 0" class="msg-error"
            style="color: orange;">
            Este alumno no tiene asignaturas contigo.
          </small>

          <small *ngIf="asigRef.invalid && (asigRef.dirty || asigRef.touched)" class="msg-error">
            <div *ngIf="asigRef.errors?.['required']">La asignatura es obligatoria.</div>
          </small>
        </div>

        <div style="width: 150px;">
          <label class="form-label">Nota:</label>
          <input type="number" class="form-control" name="valor" [(ngModel)]="valorNota" (input)="validarNota($event)"
            min="0" max="10" step="0.01" placeholder="0 - 10" required style="width: 100%;">
        </div>

        <div style="display: flex; gap: 10px; align-items: flex-end; height: 100%; padding-top: 24px;">
          <button type="submit" class="btn-guardar" [disabled]="formNotas.invalid || (cargando$ | async)"
            [title]="formNotas.invalid ? 'Rellena todos los campos correctamente' : 'Guardar'">
            {{ notaIdEditar === 0 ? 'ğŸ’¾ Guardar' : 'ğŸ”„ Actualizar' }}
          </button>

          <button *ngIf="notaIdEditar !== 0" type="button" (click)="limpiar()" class="btn-cancelar">âŒ</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div *ngIf="(cargando$ | async)" class="loading-container">
  <div class="spinner"></div>
  <p>Procesando notas...</p>
</div>

<table class="tabla-datos" *ngIf="!(cargando$ | async)">
  <thead>
    <tr>
      <th>Alumno</th>
      <th>Asignatura</th>
      <th>Nota</th>
      <th *ngIf="!api.soyAlumno()">Acciones</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let nota of notas$ | async">
      <td>{{ nota.nombreAlumno || nota.alumno }}</td>
      <td>{{ nota.nombreAsignatura || nota.asignatura }}</td>
      <td>
        <span class="badge-nota" [ngClass]="nota.valor >= 5 ? 'aprobado' : 'suspenso'">
          {{ nota.valor }}
        </span>
      </td>
      <td *ngIf="!api.soyAlumno()" style="display: flex; gap: 5px; justify-content: center;">
        <button (click)="editar(nota)" class="btn-editar">âœï¸</button>
        <button (click)="eliminar(nota.id)" class="btn-eliminar">ğŸ—‘ï¸</button>
      </td>
    </tr>
  </tbody>
</table>